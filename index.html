<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Timetable iCal Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Removed CDN ical.js to avoid ES module 'export' parse error -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/ical.js"></script> -->
</head>
<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <!-- Remove footer from header -->
        <header>
            <h1>Timetable Calendar Generator</h1>
            <p class="subtitle">Generate iCal files from your timetable data so you can see it from your mobile devices!</p>        
            <div class="controls">
                <button onclick="toggleInstructions()" class="control-button">
                    Instructions
                </button>
            </div>
        </header>

        <div id="instructions" class="instructions-section" style="display: none;">
            <div class="card">
                <h2>Instructions</h2>
                <div class="instruction-steps">
                    <h3>Step 1: Generate your timetable (.ics file)</h3>
                    <ol>
                        <li>Select your name from the drop-down menu above.</li>
                        <li>The default dates are set for the upcoming Term.</li>
                        <li>You can modify the dates if needed.</li>
                        <li>Select whether your start date falls on an Odd or Even week.</li>
                        <li>Click <strong>Generate Calendar</strong> and note where the .ics file is saved.</li>
                    </ol>

                    <h3>Step 2: Import to Google Calendar</h3>
                    <ol>
                        <li>Open <a href="https://calendar.google.com" target="_blank">Google Calendar</a></li>
                        <li>Under <strong>Other calendars</strong> on the left menu, click on the + button and <strong>Create New Calendar</strong>. This way, if your timetable changes significantly, you only need to delete this calendar and import a new one instead of changing the events one by one.</li>
                        <img src="images/add-calendar.png" alt="Add Calendar Instructions" width="240px">
                        <li>Give the calendar a name, e.g. "Term 2" and click <strong>Create calendar</strong>.</li>
                        <li>In the left menu, click <strong>Import & Export</strong></li>
                        <li>In the drop-down menu <strong>Add to calendar</strong>, select the new calendar you just created.</li>
                        <li>Click <strong>Select file from your computer</strong> and choose your .ics file</li>
                        <li>Click <strong>Import</strong>.</li>
                        <li>You should be able to see the new calendar in addition to your existing calendars.</li>
                        <img src="images/view-timetables.png" alt="View Timetables Instructions" width="240px">
                    </ol>
                </div>
            </div>
        </div>

        <main>
            <section id="previewSection" class="preview-section card">
                <h2>Generate Preview</h2>
                <!-- Inside the form-grid, add the XML dropdown -->
                <div class="form-grid">
                    <!-- Add this before the teacher select -->
                    <div class="form-group">
                        <label for="xmlSelect">Timetable XML:</label>
                        <select id="xmlSelect" class="select-input"></select>
                    </div>

                    <!-- Department filter -->
                    <div class="form-group">
                        <label for="departmentSelect">Department:</label>
                        <select id="departmentSelect" class="select-input"></select>
                    </div>

                    <div class="form-group">
                        <label for="teacherSelect">Select Teacher:</label>
                        <select id="teacherSelect" class="select-input"></select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate" class="date-input">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate" class="date-input">
                    </div>
                    <div class="form-group">
                        <label for="weekType">Starting Week Type:</label>
                        <select id="weekType" class="select-input">
                            <option value="odd">Odd Week</option>
                            <option value="even">Even Week</option>
                        </select>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="processXML()" class="button primary">Generate Calendar</button>
                    <p id="progress" class="progress-text"></p>
                </div>
                <div id="timetableTables"></div>
            </section>

            <!-- Add id to the admin section -->
            <section id="adminSection" class="input-section card admin-section" style="display: none;">
                <div class="admin-header">
                    <h2>Admin Data Input</h2>
                    <span class="optional-tag">Optional</span>
                </div>
                <p class="admin-description">This section is for administrative purposes only. Use it to upload a custom XML file if needed. Do note that the XML file is not saved.</p>
                <div class="file-input-wrapper">
                    <input type="file" id="xmlFile" accept=".xml" class="file-input">
                    <label for="xmlFile" class="file-label">Choose XML File</label>
                    <span class="file-name">No file chosen</span>
                </div>
                <button onclick="previewTimetable()" class="button secondary">Preview Timetable</button>
            </section>
        </main>
    </div>
    <!-- Move footer to the bottom, before closing body tag -->
    
    <style>
        .admin-controls {
            display: flex;
            justify-content: center;
            padding: 20px 0;
            border-top: 1px solid #eee;
            margin-top: auto;
            background: #f9f9f9;
            width: 100%;
        }
        
        .footer-content {
            text-align: center;
        }
        
        .update-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .verification-note {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .verification-note a {
            color: #007AFF;
            text-decoration: none;
        }
        
        .verification-note a:hover {
            text-decoration: underline;
        }
        
        .admin-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .admin-button {
            background: #f5f5f5;
            color: #666;
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .admin-button:hover {
            background: #e9e9e9;
            color: #333;
        }
    </style>
    <script src="ical.min.js"></script>
    <script src="timetable.refactor.js" defer></script>
    <script>
function toggleInstructions() {
    const el = document.getElementById('instructions');
    if (!el) return;
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}
// Load shared header
fetch('header.html')
    .then(response => response.text())
    .then(data => {
        document.getElementById('header-placeholder').innerHTML = data;
        
        // Highlight current page
        const currentPage = window.location.pathname.split('/').pop() || 'index.html';
        const navButtons = document.querySelectorAll('.nav-button');
        navButtons.forEach(button => {
            if (button.getAttribute('href') === currentPage) {
                button.classList.add('active');
            }
        });
    })
    .catch(error => console.error('Error loading header:', error));

// Dropdown-based XML loader
async function loadSelectedXML(path) {
    try {
        const response = await fetch(path);
        if (!response.ok) throw new Error(`HTTP ${response.status} when fetching ${path}`);
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        if (xmlDoc.querySelector('parsererror')) {
            throw new Error('Invalid XML file');
        }

        // Always set global XML so processXML() can proceed
        window.xmlData = xmlDoc;

        // If timetable.js is loaded, let it update UI state
        if (typeof window.setTimetableXML === 'function') {
            window.setTimetableXML(xmlDoc);
        } else {
            console.warn('setTimetableXML not available yet; preview may not update until timetable.js loads.');
        }

        // Return the parsed document so callers can await it
        return xmlDoc;
    } catch (err) {
        console.error('Failed to load selected XML:', err);
        alert(`Failed to load selected XML: ${err.message}`);
        return null;
    }
}

// Dynamically populate the XML dropdown by parsing directory listing
async function populateXMLDropdown() {
    const select = document.getElementById('xmlSelect');
    if (!select) return;

    try {
        const res = await fetch('timetables/');
        const html = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const links = Array.from(doc.querySelectorAll('a'));
        const xmlFiles = links
            .map(a => a.getAttribute('href') || '')
            .filter(href => href.toLowerCase().endsWith('.xml'));

        // Build options, preferring Term1_W3_onwards.xml first
        select.innerHTML = '';
        const preferred = ['Term1_W3_onwards.xml'];
        const orderedFiles = [...xmlFiles].sort((a, b) => {
            const aPref = preferred.includes(a);
            const bPref = preferred.includes(b);
            if (aPref && !bPref) return -1;
            if (!aPref && bPref) return 1;
            return a.localeCompare(b);
        });
        orderedFiles.forEach(name => {
            const option = document.createElement('option');
            option.value = `timetables/${name}`;
            option.textContent = name;
            select.appendChild(option);
        });

        // Fallback if no listing available
        if (select.options.length === 0) {
            ['Term1_W3_onwards.xml', 'SOTY2026.xml'].forEach(name => {
                const option = document.createElement('option');
                option.value = `timetables/${name}`;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        // Auto-load first item if none selected
        if (!select.value && select.options.length > 0) {
            const preferred = ['timetables/Term1_W3_onwards.xml'];
            let idx = -1;
            for (let i = 0; i < select.options.length; i++) {
                if (preferred.includes(select.options[i].value)) { idx = i; break; }
            }
            select.selectedIndex = idx >= 0 ? idx : 0;
            loadSelectedXML(select.value);
        }
    } catch (e) {
        console.error('Failed to list timetables directory:', e);
        // Fallback: use known filenames only from timetables/ (no asctt2012.xml)
        const files = [
            { name: 'Term1_W3_onwards.xml', path: 'timetables/Term1_W3_onwards.xml' },
            { name: 'SOTY2026.xml', path: 'timetables/SOTY2026.xml' },
        ];
        select.innerHTML = '';
        files.forEach(({ name, path }) => {
            const option = document.createElement('option');
            option.value = path;
            option.textContent = name;
            select.appendChild(option);
        });
        if (select.options.length > 0) {
            const preferred = ['timetables/Term1_W3_onwards.xml'];
            let idx = -1;
            for (let i = 0; i < select.options.length; i++) {
                if (preferred.includes(select.options[i].value)) { idx = i; break; }
            }
            select.selectedIndex = idx >= 0 ? idx : 0;
            loadSelectedXML(select.value);
        }
    }
}

function computeWeekTypeFromDate(dateObj) {
    if (!(dateObj instanceof Date) || isNaN(dateObj)) return 'odd';
    const start = new Date(Date.UTC(2026, 0, 5));
    const toMonday = (x) => {
        if (!(x instanceof Date) || isNaN(x)) return null;
        const y = new Date(Date.UTC(x.getUTCFullYear(), x.getUTCMonth(), x.getUTCDate()));
        const w = y.getUTCDay();
        const diff = (w + 6) % 7;
        y.setUTCDate(y.getUTCDate() - diff);
        return y;
    };
    const a = toMonday(dateObj);
    const s = toMonday(start);
    if (!a || !s) return 'odd';
    let weeks = Math.floor((a - s) / (7 * 86400000));
    if (!isFinite(weeks)) return 'odd';
    if (weeks < 0) return 'odd';
    const blocks = [10, 10, 10, 10];
    const breaks = [1, 4, 1];
    let t = weeks;
    for (let i = 0; i < 100; i++) {
        const b = blocks[i % blocks.length];
        if (t < b) {
            const n = (t + 1);
            return n % 2 === 1 ? 'odd' : 'even';
        }
        t -= b;
        const br = breaks[i % breaks.length];
        if (t < br) {
            return 'odd';
        }
        t -= br;
    }
    return 'odd';
}

// Initialize XML dropdown and hook change events
document.addEventListener('DOMContentLoaded', () => {
    const xmlSelect = document.getElementById('xmlSelect');
    if (xmlSelect) {
        xmlSelect.addEventListener('change', (e) => {
            loadSelectedXML(e.target.value);
        });
    }
    populateXMLDropdown();
    const weekTypeSelect = document.getElementById('weekType');
    const startDateInput = document.getElementById('startDate');
    if (weekTypeSelect && startDateInput) {
        const initVal = startDateInput.value;
        if (initVal) {
            const d = new Date(initVal + 'T00:00:00');
            weekTypeSelect.value = computeWeekTypeFromDate(d);
        }
        const parseDateInput = (v) => {
            const parts = (v || '').split('-').map(Number);
            if (parts.length !== 3 || parts.some(isNaN)) return null;
            return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
        };
        startDateInput.addEventListener('change', () => {
            const v = startDateInput.value;
            if (!v) return;
            const d = parseDateInput(v);
            weekTypeSelect.value = computeWeekTypeFromDate(d || new Date());
        });
    }
});
    async function processXML() {
        const teacherSelect = document.getElementById('teacherSelect');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const weekTypeSelect = document.getElementById('weekType');
        const progressEl = document.getElementById('progress');

        // Basic validations
        if (!teacherSelect || !teacherSelect.value) {
            alert('Please select a teacher before generating the calendar.');
            return;
        }
        if (!startDateInput || !startDateInput.value) {
            alert('Please select a Start Date.');
            return;
        }
        if (!endDateInput || !endDateInput.value) {
            alert('Please select an End Date.');
            return;
        }
        if (!weekTypeSelect || !weekTypeSelect.value) {
            alert('Please select Starting Week Type (Odd/Even).');
            return;
        }

        const selectedTeacherId = teacherSelect.value;
        // If XML not yet loaded, try loading the currently selected option and wait
        if (!window.xmlData) {
            const xmlSelect = document.getElementById('xmlSelect');
            if (xmlSelect && xmlSelect.value) {
                await loadSelectedXML(xmlSelect.value);
            }
        }
        if (!window.xmlData) {
            alert('No timetable XML loaded. Please select a timetable XML first.');
            return;
        }
        if (selectedTeacherId && teacherSelect) {
            teacherSelect.value = selectedTeacherId;
        }
        if (typeof window.createTeacherCalendar !== 'function' || typeof window.downloadICS !== 'function') {
            alert('Calendar generation functions are not available. Please ensure timetable.js is loaded.');
            return;
        }

        // Show progress
        if (progressEl) {
            progressEl.textContent = 'Generating calendar...';
        }

        // Generate and download ICS
        const teacherId = selectedTeacherId;
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        const startWeekType = weekTypeSelect.value;
        const calendar = window.createTeacherCalendar(teacherId, startDate, endDate, startWeekType);

        // Use the teacher short name or ID for filename
        const teacherOption = teacherSelect.selectedOptions[0];
        const label = teacherOption ? teacherOption.textContent.trim() : teacherId;
        window.downloadICS(calendar, label);

        if (progressEl) {
            progressEl.textContent = 'Calendar generated.';
            setTimeout(() => progressEl.textContent = '', 1500);
        }
    }
</script>
</body>
</html>
